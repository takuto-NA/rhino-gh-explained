---
order: 39
---

# 直線・円弧（LINE/ARC）で点列を再現する（セグメント化とDXF）

Q: このページの目的は何ですか？

A: 本ページは `point-to-curve.md` の詳細解説として、点列をCAD/CAMやDXFエクスポートで扱いやすい「直線（Line）」と「円弧（Arc）」の組み合わせに変換（セグメント化）する手法と、その際の判断基準について解説します。

## 直線・円弧セグメント化の基本アプローチ

Q: 点列を直線と円弧の組み合わせに変換するには、どのようなワークフローが推奨されますか？

A: 主に以下の2つのアプローチがあります。用途や精度要件に応じて使い分けます。

**アプローチ1：点列を直接セグメント分割してフィットする**
1. **分割点の決定**: 曲率が急変する場所や方向が変わる場所で点列をグループ分けします。
2. **要素のフィット**: 直線に近い区間には `Fit Line`、円弧に近い区間には `Fit Arc` コンポーネントを使用し、最小二乗法で幾何要素を当てはめます。
3. **セグメントの結合**: 各要素を順番に接続して PolyCurve を作成します。

**アプローチ2：滑らかなNURBS曲線を経由して自動分割する（推奨）**
1. **NURBS化**: 点列から `Interpolate` 等で一度滑らかな曲線を作ります。
2. **曲率分析**: 曲線上の曲率を分析し、「曲率がほぼ0の区間（＝直線）」と「曲率が一定の区間（＝円弧）」を自動で検出します。
3. **分割と近似**: 検出した境界で曲線を分割し、各区間に `Fit Line` / `Fit Arc` を適用して再構成します。

## RhinoCommonによる最短の実装方法

Q: スクリプト（C#やPython）を使用して、より効率的に直線・円弧化する方法はありますか？

A: RhinoCommon APIの `Curve.ToArcsAndLines` メソッドを使用するのが最も確実で高速です。

- **機能**: 入力曲線を、指定した距離許容差（Tolerance）と角度許容差（Angle Tolerance）を満たすように、直線と円弧のセグメントからなる PolyCurve に自動分解します。
- **利点**: 自分で曲率分析や分割ロジックを書く必要がなく、DXF出力用のデータ作成においてはデファクトスタンダードな手法です。

```csharp
// C#スクリプトでの実行例（要点）
PolyCurve result = inputCurve.ToArcsAndLines(
    tolerance: linearTol, 
    angleTolerance: angleTolRadians, 
    minimumLength: minLen, 
    maximumLength: maxLen
);
```

## 曲率分析によるセグメント境界の特定

Q: 曲線が「どこで直線から円弧に切り替わるか」を判断するための可視化や分析手法は？

A: Grasshopperの分析コンポーネントを組み合わせて、セグメントの切り替わり（境界）を特定します。

- **曲率の可視化**: `Curvature Graph` を使用し、曲率半径の変化を目視で確認します。
- **数値的な判定**: `Curvature` コンポーネントで取得した曲率値（1/半径）の変化率を計算します。隣接する評価点間での曲率の差分が急増する箇所が、セグメント境界の有力な候補となります。
- **グラフ化**: `Graph Mapper` 等を用いて、曲線のパラメータに対する曲率値をプロットし、曲率がプラトー（一定）になっている区間を円弧として抽出します。

## DXF出力における形式の選択（Polyline vs Line/Arc）

Q: DXFエクスポートの際、細かい直線（Polyline）で出すのと、幾何要素（Line/Arc）で出すのはどちらが良いですか？

A: 基本的には **直線（Line）と円弧（Arc）の組み合わせ（アプローチ2）** を推奨します。

| 項目 | 細かい直線の集合（Polyline） | 直線と円弧の組み合わせ（推奨） |
| :--- | :--- | :--- |
| **CADでの操作** | 重い（セグメント数が多いため） | 軽い（要素数が最小限） |
| **編集性** | 困難（単なる点列の繋がり） | 容易（オフセットやフィレットが可能） |
| **ファイルサイズ** | 大きい | 非常に小さい |
| **加工精度** | 点密度に依存 | 滑らか（CAM側で円弧補間が効く） |

**例外的にPolylineが適すケース**:
- 形状が極めて不規則で、円弧近似が現実的でない場合。
- CAD上での編集を一切行わず、形状の忠実な再現のみが求められるプロトタイプ段階。

## 実装時の注意点とチェックリスト

Q: セグメント化を実行する際に、最終的なデータの品質を保つために確認すべきことは？

A: 以下の項目を確認し、製造工程（CAM等）でのトラブルを未然に防ぎます。

- **位置連続性（G0）の確保**: セグメント間の接続点に隙間がないか。DXF単位系で 0.001〜0.01 程度の精度が必要です。
- **最小セグメント長**: 極端に短い要素（0.1mm以下など）が混入していないか。加工機がガタつく原因になります。
- **円弧の向き**: DXF形式では円弧は反時計回りが標準です。スクリプトで書き出す際は角度の定義に注意してください。
- **許容誤差のバランス**: 精度を求めすぎてセグメント数が増えすぎていないか、逆に滑らかさを優先して元形状から逸脱しすぎていないかを確認します。
